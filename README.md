# imgs smart contract

`imgs` is a minimal ERC-721 style marketplace that lets creators post image URLs with a mint price and lets collectors mint tokens that point to those URLs. Each mint forwards the payment to the original poster while maintaining full token enumeration support (name, symbol, `tokenURI`, `tokenByIndex`, and `tokenOfOwnerByIndex`).

## Features
- Register image posts with an asking price via `post(url, price)`
- Mint ERC-721 compatible tokens that reference the posted URL and emit standard `Transfer` events
- Automatic revenue forwarding to the post creator with manual reentrancy protection
- Full token enumeration helpers (`balanceOf`, `tokenByIndex`, etc.) backed by on-chain bookkeeping
- Comprehensive Foundry test suite covering happy paths, failure cases, and attack attempts

## Repository layout
- `src/imgs.sol` – the core contract implementation
- `test/imgs.t.sol` – Foundry tests that exercise posting, minting, payments, and guard rails
- `foundry.toml` – project configuration including Optimism RPC/Etherscan placeholders
- `lib/forge-std` – testing utilities vendored from Foundry's standard library

## Getting started
1. Install [Foundry](https://book.getfoundry.sh/getting-started/installation):
   ```bash
   curl -L https://foundry.paradigm.xyz | bash
   foundryup
   ```
2. Fetch dependencies (only needed if `lib` is empty):
   ```bash
   forge install
   ```

## Development tasks
Run the usual Foundry workflows from the project root:
- `forge build` – compile the contracts
- `forge test` – execute the unit tests in `test/`
- `forge fmt` – format Solidity sources
- `forge snapshot` – record gas snapshots (optional)

## Contract walkthrough
Typical interaction flow:
1. **Creator posts an image**
   ```solidity
   uint256 postId = imgs.post("https://example.com/art.png", 0.1 ether);
   ```
   The contract stores the URL and price while tracking the posting account.
2. **Collector mints**
   ```solidity
   imgs.mint{value: 0.1 ether}(postId);
   ```
   - Reverts if the post id is invalid or the payment is too low.
   - Mints a new token whose `tokenURI` equals the post URL.
   - Forwards the price (if > 0) to the original poster and guards against reentrancy.
3. **Reading state**
   - `tokenURI(tokenId)` returns the stored image URL.
   - `tokenOfOwnerByIndex(account, i)` enumerates owned tokens.
   - `supportsInterface` reports ERC-165, ERC-721, metadata, and enumerable support.

## Deployment
`foundry.toml` includes placeholders for Optimism RPC and Etherscan keys. Export environment variables before running deployment commands:
```bash
export OPTIMISM_RPC_URL="https://..."
export ETHERSCAN_API_KEY="<etherscan-key>"
```
You can deploy with Forge directly:
```bash
forge create src/imgs.sol:imgs \
  --rpc-url $OPTIMISM_RPC_URL \
  --private-key $PRIVATE_KEY
```
Adjust the RPC URL and private key to match the target network and account.

## Testing
The Foundry tests cover:
- Metadata queries (`name`, `symbol`, `tokenURI`, enumeration helpers)
- Posting and minting logic, including multiple minters and free mints
- Payment forwarding failures (e.g., recipients that reject ETH)
- Guard rails for insufficient payment, invalid IDs, and manual reentrancy attempts

Run `forge test` to verify the contract before deploying or modifying it.

## Live Deployment
The contract currently lives on Base at `0xc112a5fdfaa2f3d160cc0f12f5a61790c11f0e6b` using CREATE2 with salt ``0x0000000000000000000000000000000000000000f00df00df00df00df00df00d``. The deployed bytecode was:
```text
0x6080604052348015600e575f80fd5b506117438061001c5f395ff3fe6080604052600436106100e7575f3560e01c80632f745c591161008957806370a082311161005857806370a082311461034b57806395d89b4114610387578063a0712d68146103b1578063c87b56dd146103e1576100e7565b80632f745c591461025b5780634e6c3c95146102975780634f6ccce7146102d35780636352211e1461030f576100e7565b80630b1e7f83116100c55780630b1e7f831461018d57806316865fe3146101cb57806317906c2e1461020757806318160ddd14610231576100e7565b806301ffc9a7146100eb57806303fac3c31461012757806306fdde0314610163575b5f80fd5b3480156100f6575f80fd5b50610111600480360381019061010c9190610f41565b61041d565b60405161011e9190610f86565b60405180910390f35b348015610132575f80fd5b5061014d6004803603810190610148919061102c565b6104de565b60405161015a9190611079565b60405180910390f35b34801561016e575f80fd5b50610177610509565b6040516101849190611102565b60405180910390f35b348015610198575f80fd5b506101b360048036038101906101ae9190611122565b610546565b6040516101c29392919061115c565b60405180910390f35b3480156101d6575f80fd5b506101f160048036038101906101ec9190611122565b610620565b6040516101fe9190611102565b60405180910390f35b348015610212575f80fd5b5061021b6106bb565b6040516102289190611079565b60405180910390f35b34801561023c575f80fd5b506102456106c1565b6040516102529190611079565b60405180910390f35b348015610266575f80fd5b50610281600480360381019061027c919061102c565b6106c7565b60405161028e9190611079565b60405180910390f35b3480156102a2575f80fd5b506102bd60048036038101906102b891906112c4565b610806565b6040516102ca9190611079565b60405180910390f35b3480156102de575f80fd5b506102f960048036038101906102f49190611122565b6108ed565b6040516103069190611079565b60405180910390f35b34801561031a575f80fd5b5061033560048036038101906103309190611122565b610931565b604051610342919061131e565b60405180910390f35b348015610356575f80fd5b50610371600480360381019061036c9190611337565b610961565b60405161037e9190611079565b60405180910390f35b348015610392575f80fd5b5061039b6109aa565b6040516103a89190611102565b60405180910390f35b6103cb60048036038101906103c69190611122565b6109e7565b6040516103d89190611079565b60405180910390f35b3480156103ec575f80fd5b5061040760048036038101906104029190611122565b610dff565b6040516104149190611102565b60405180910390f35b5f6301ffc9a760e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916148061047757506380ac58cd60e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b806104a75750635b5e139f60e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b806104d7575063780e9d6360e01b827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b9050919050565b6003602052815f5260405f2081815481106104f7575f80fd5b905f5260205f20015f91509150505481565b60606040518060400160405280600481526020017f696d677300000000000000000000000000000000000000000000000000000000815250905090565b60048181548110610555575f80fd5b905f5260205f2090600302015f91509050805f015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff16908060010180546105999061138f565b80601f01602080910402602001604051908101604052809291908181526020018280546105c59061138f565b80156106105780601f106105e757610100808354040283529160200191610610565b820191905f5260205f20905b8154815290600101906020018083116105f357829003601f168201915b5050505050908060020154905083565b6001602052805f5260405f205f91509050805461063c9061138f565b80601f01602080910402602001604051908101604052809291908181526020018280546106689061138f565b80156106b35780601f1061068a576101008083540402835291602001916106b3565b820191905f5260205f20905b81548152906001019060200180831161069657829003601f168201915b505050505081565b60065481565b60055481565b5f8073ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff160361072d576040517fd92e233d00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60035f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f208054905082106107a6576040517f4e23d03500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60035f8473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2082815481106107f5576107f46113bf565b5b905f5260205f200154905092915050565b5f806006549050600460405180606001604052803373ffffffffffffffffffffffffffffffffffffffff16815260200186815260200185815250908060018154018082558091505060019003905f5260205f2090600302015f909190919091505f820151815f015f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060208201518160010190816108bf9190611589565b5060408201518160020155505060065f8154809291906108de90611685565b91905055508091505092915050565b5f6005548210610929576040517f4e23d03500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b819050919050565b6002602052805f5260405f205f915054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b5f60035f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20805490509050919050565b60606040518060400160405280600481526020017f494d475300000000000000000000000000000000000000000000000000000000815250905090565b5f805f9054906101000a900460ff1615610a2d576040517f37ed32e800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60015f806101000a81548160ff0219169083151502179055506004805490508210610a84576040517f7e81c05500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f60048381548110610a9957610a986113bf565b5b905f5260205f2090600302016040518060600160405290815f82015f9054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001600182018054610b149061138f565b80601f0160208091040260200160405190810160405280929190818152602001828054610b409061138f565b8015610b8b5780601f10610b6257610100808354040283529160200191610b8b565b820191905f5260205f20905b815481529060010190602001808311610b6e57829003601f168201915b5050505050815260200160028201548152505090508060400151341015610bde576040517fcd1c886700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f600554905060055f815480929190610bf690611685565b91905055503360025f8381526020019081526020015f205f6101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555060035f3373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f2081908060018154018082558091505060019003905f5260205f20015f9091909190915055816020015160015f8381526020019081526020015f209081610ccd9190611589565b50803373ffffffffffffffffffffffffffffffffffffffff165f73ffffffffffffffffffffffffffffffffffffffff167fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef60405160405180910390a45f82604001511115610ddd575f825f015173ffffffffffffffffffffffffffffffffffffffff168360400151604051610d61906116f9565b5f6040518083038185875af1925050503d805f8114610d9b576040519150601f19603f3d011682016040523d82523d5f602084013e610da0565b606091505b5050905080610ddb576040517f90b8ec1800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b505b5f805f6101000a81548160ff0219169083151502179055508092505050919050565b60606005548210610e3c576040517f3f6cc76800000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b60015f8381526020019081526020015f208054610e589061138f565b80601f0160208091040260200160405190810160405280929190818152602001828054610e849061138f565b8015610ecf5780601f10610ea657610100808354040283529160200191610ecf565b820191905f5260205f20905b815481529060010190602001808311610eb257829003601f168201915b50505050509050919050565b5f604051905090565b5f80fd5b5f80fd5b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b610f2081610eec565b8114610f2a575f80fd5b50565b5f81359050610f3b81610f17565b92915050565b5f60208284031215610f5657610f55610ee4565b5b5f610f6384828501610f2d565b91505092915050565b5f8115159050919050565b610f8081610f6c565b82525050565b5f602082019050610f995f830184610f77565b92915050565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f610fc882610f9f565b9050919050565b610fd881610fbe565b8114610fe2575f80fd5b50565b5f81359050610ff381610fcf565b92915050565b5f819050919050565b61100b81610ff9565b8114611015575f80fd5b50565b5f8135905061102681611002565b92915050565b5f806040838503121561104257611041610ee4565b5b5f61104f85828601610fe5565b925050602061106085828601611018565b9150509250929050565b61107381610ff9565b82525050565b5f60208201905061108c5f83018461106a565b92915050565b5f81519050919050565b5f82825260208201905092915050565b8281835e5f83830152505050565b5f601f19601f8301169050919050565b5f6110d482611092565b6110de818561109c565b93506110ee8185602086016110ac565b6110f7816110ba565b840191505092915050565b5f6020820190508181035f83015261111a81846110ca565b905092915050565b5f6020828403121561113757611136610ee4565b5b5f61114484828501611018565b91505092915050565b61115681610fbe565b82525050565b5f60608201905061116f5f83018661114d565b818103602083015261118181856110ca565b9050611190604083018461106a565b949350505050565b5f80fd5b5f80fd5b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b6111d6826110ba565b810181811067ffffffffffffffff821117156111f5576111f46111a0565b5b80604052505050565b5f611207610edb565b905061121382826111cd565b919050565b5f67ffffffffffffffff821115611232576112316111a0565b5b61123b826110ba565b9050602081019050919050565b828183375f83830152505050565b5f61126861126384611218565b6111fe565b9050828152602081018484840111156112845761128361119c565b5b61128f848285611248565b509392505050565b5f82601f8301126112ab576112aa611198565b5b81356112bb848260208601611256565b91505092915050565b5f80604083850312156112da576112d9610ee4565b5b5f83013567ffffffffffffffff8111156112f7576112f6610ee8565b5b61130385828601611297565b925050602061131485828601611018565b9150509250929050565b5f6020820190506113315f83018461114d565b92915050565b5f6020828403121561134c5761134b610ee4565b5b5f61135984828501610fe5565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52602260045260245ffd5b5f60028204905060018216806113a657607f821691505b6020821081036113b9576113b8611362565b5b50919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f819050815f5260205f209050919050565b5f6020601f8301049050919050565b5f82821b905092915050565b5f600883026114487fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8261140d565b611452868361140d565b95508019841693508086168417925050509392505050565b5f819050919050565b5f61148d61148861148384610ff9565b61146a565b610ff9565b9050919050565b5f819050919050565b6114a683611473565b6114ba6114b282611494565b848454611419565b825550505050565b5f90565b6114ce6114c2565b6114d981848461149d565b505050565b5b818110156114fc576114f15f826114c6565b6001810190506114df565b5050565b601f82111561154157611512816113ec565b61151b846113fe565b8101602085101561152a578190505b61153e611536856113fe565b8301826114de565b50505b505050565b5f82821c905092915050565b5f6115615f1984600802611546565b1980831691505092915050565b5f6115798383611552565b9150826002028217905092915050565b61159282611092565b67ffffffffffffffff8111156115ab576115aa6111a0565b5b6115b5825461138f565b6115c0828285611500565b5f60209050601f8311600181146115f1575f84156115df578287015190505b6115e9858261156e565b865550611650565b601f1984166115ff866113ec565b5f5b8281101561162657848901518255600182019150602085019450602081019050611601565b86831015611643578489015161163f601f891682611552565b8355505b6001600288020188555050505b505050505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61168f82610ff9565b91507fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff82036116c1576116c0611658565b5b600182019050919050565b5f81905092915050565b50565b5f6116e45f836116cc565b91506116ef826116d6565b5f82019050919050565b5f611703826116d9565b915081905091905056fea2646970667358221220c6c84c8eca726bc0cd11e761dc30ddfae78f02bb1b072f9300c6b52ad82f57d364736f6c63430008190033
```


## License
The Solidity sources now use the `MIT` SPDX identifier. Ensure downstream consumers adopt compatible licensing terms.
